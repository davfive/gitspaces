name: Test pip-cache action

on:
  workflow_dispatch: {}

jobs:
  test-pip-cache:
    name: Test pip-cache (fast diagnostics)
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            windows-shell: ''
          - os: windows-latest
            windows-shell: cmd
          - os: windows-latest
            windows-shell: pwsh
          - os: windows-latest
            windows-shell: wsl
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Prepare pip cache (invoke action)
        uses: ./.github/actions/pip-cache
        with:
          python-version: '3.13'
          windows-shell: ${{ matrix.windows-shell }}

      - name: Install dev dependencies (linux)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Install dev dependencies (windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Show pip cache dir (bash)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        shell: bash
        run: |
          echo "pip --version: $(python -m pip --version 2>/dev/null || true)"
          echo "pip cache dir:"
          python -m pip cache dir || true
          CACHE_DIR=$(python -m pip cache dir 2>/dev/null | sed -n '1p') || true
          if [ -n "$CACHE_DIR" ] && [ -d "$CACHE_DIR" ]; then
            echo "Listing cache contents (first 200 lines):"
            ls -lah "$CACHE_DIR" | sed -n '1,200p' || true
          else
            echo "Cache dir not found or empty: $CACHE_DIR"
          fi

      - name: Show pip cache dir (pwsh)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          Write-Host "pip --version:"; python -m pip --version
          Write-Host "pip cache dir:"; python -m pip cache dir
          $p = (python -m pip cache dir)
          if ($p -and (Test-Path $p)) {
            Write-Host "Listing cache (first 200 entries):";
            Get-ChildItem -Path $p -Recurse -Force | Select-Object -First 200
          } else { Write-Host "Cache path not present: $p" }

      - name: Done
        run: echo "pip-cache test finished"
