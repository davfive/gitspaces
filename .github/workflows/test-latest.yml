name: "01 â€” Python Tests (latest only)"

on:
  push:
    branches: [ main, 'd5.**', 'copilot/**', 'ci/**' ]
  workflow_dispatch: {}
  workflow_call:
    inputs:
      run-codeql:
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  vars:
    uses: ./.github/workflows/vars.yml

  static:
    needs: vars
    uses: ./.github/workflows/static-checks.yml
    with:
      run-security: true
      python-for-tools: ${{ needs.vars.outputs.python_versions_latest }}
    permissions:
      contents: read
      security-events: write

  test:
    needs: [vars, static]
    name: test-${{ matrix.platform.os }}.${{ matrix.platform.shell }}.latest
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-latest
            shell: bash
          - os: macos-latest
            shell: bash
          - os: windows-latest
            shell: pwsh
          - os: windows-latest
            shell: cmd
          - os: windows-latest
            shell: wsl-bash

    steps:
      - uses: actions/checkout@v4

      # Git config tuning for Windows cmd/pwsh (faster file operations)
      - name: Configure Git for Windows performance
        if: runner.os == 'Windows' && matrix.platform.shell != 'wsl-bash'
        shell: cmd
        run: |
          git config --global core.autocrlf false
          git config --global core.fsyncObjectFiles false
          git config --global gc.auto 0

      # Predownload wheels for faster installation (Unix/macOS)
      - name: Predownload wheels (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          python -m pip install --upgrade pip
          mkdir -p wheels
          pip download -r requirements-dev.txt -d wheels/ || true

      # Predownload wheels for faster installation (Windows cmd/pwsh)
      - name: Predownload wheels (Windows)
        if: runner.os == 'Windows' && matrix.platform.shell != 'wsl-bash'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          New-Item -ItemType Directory -Force -Path wheels | Out-Null
          pip download -r requirements-dev.txt -d wheels/ 2>&1 | Out-Null
          if ($LASTEXITCODE -ne 0) { Write-Host "Some wheels failed to download, will use fallback" }

      - name: Run tests (Python 3.13)
        uses: ./.github/actions/run-tests
        with:
          python-version: '3.13'
          upload-coverage: ${{ matrix.platform.os == 'ubuntu-latest' && matrix.platform.shell == 'bash' && 'true' || 'false' }}
          windows-shell: ${{ matrix.platform.shell == 'wsl-bash' && 'wsl' || matrix.platform.shell }}
