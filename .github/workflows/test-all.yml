name: "02 â€” Python Tests (all supported versions)"

on:
  workflow_dispatch: {}
  pull_request:
    branches: [ main ]
  workflow_call:
    inputs:
      run-codeql:
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  LATEST_PYTHON_VERSION: '3.13'

jobs:
  static:
    uses: ./.github/workflows/static-checks.yml
    with:
      run-security: true
      python-for-tools: '3.13'
    permissions:
      contents: read
      security-events: write

  test:
    needs: static
    name: test-${{ matrix.platform.name }}-pyall
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-latest
            shell: bash
            name: ubuntu-bash
          - os: macos-latest
            shell: bash
            name: macos-bash
          - os: windows-latest
            shell: pwsh
            name: windows-pwsh
          - os: windows-latest
            shell: cmd
            name: windows-cmd
          - os: windows-latest
            shell: wsl-bash
            name: windows-wsl

    steps:
      - uses: actions/checkout@v4

      - name: test-${{ matrix.platform.name }}-py3.13
        uses: ./.github/actions/run-tests
        with:
          python-version: '3.13'
          upload-coverage: ${{ matrix.platform.os == 'ubuntu-latest' && matrix.platform.shell == 'bash' && 'true' || 'false' }}
          windows-shell: ${{ matrix.platform.shell == 'wsl-bash' && 'wsl' || matrix.platform.shell }}

      - name: test-${{ matrix.platform.name }}-py3.12
        uses: ./.github/actions/run-tests
        with:
          python-version: '3.12'
          windows-shell: ${{ matrix.platform.shell == 'wsl-bash' && 'wsl' || matrix.platform.shell }}

      - name: test-${{ matrix.platform.name }}-py3.11
        uses: ./.github/actions/run-tests
        with:
          python-version: '3.11'
          windows-shell: ${{ matrix.platform.shell == 'wsl-bash' && 'wsl' || matrix.platform.shell }}

      - name: test-${{ matrix.platform.name }}-py3.10
        uses: ./.github/actions/run-tests
        with:
          python-version: '3.10'
          windows-shell: ${{ matrix.platform.shell == 'wsl-bash' && 'wsl' || matrix.platform.shell }}

      - name: test-${{ matrix.platform.name }}-py3.9
        uses: ./.github/actions/run-tests
        with:
          python-version: '3.9'
          windows-shell: ${{ matrix.platform.shell == 'wsl-bash' && 'wsl' || matrix.platform.shell }}
